#include"page.h"

const char*HTML_STR="<!DOCTYPE html><html lang='en'><link rel='stylesheet'href='style.css'type='text/css'/><head><title>Remote assistant</title></head><body id='body'><header><nav><span>ESP8266</span><input type='button'onclick='getSetting()'value='Get settings'/><input type='button' onclick='getInfo()'value='Get info'/><button id='exit'onclick='serverExit()'>Quit</button></nav></header><div id='modal'class='hide'></div><div class='setting_page' id='settings_forms'></div><footer>2024</footer><script src='script.js'></script></body></html>";

const char*STYLE_STR = "fieldset{margin:1rem 10%;font-size:larger;color:#0662a8;border-radius:1rem;border-color:#8cadc6;background-color:#e7edf1;}button, input{font-size:larger;padding:0.4rem;margin-bottom:1rem;margin-right:1rem;}button, input[type='button'], input[type='submit']{user-select:none;color:#fff;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;border-radius:5px;background-color:rgb(26, 86, 158);border:none;font-size:1.5rem;}button:hover, input[type='submit']:hover, input[type='button']:hover{opacity:0.8 !important;}nav{user-select:none;display:flex;flex-wrap:wrap;align-items:center;min-width:100%;margin:0;left:0;top:0;background-color:rgb(26, 86, 158);padding:0.5rem 0;margin-bottom:1rem;}body{font-size:larger;font-family:sans-serif;padding:0px;margin:0px;width:100%;height:fit-content;}nav span{margin:1rem;font-size:2rem;width:content;color:#00f0f9;margin-right:auto;}nav form{width:fit-content;display:block;}footer{text-align:center;padding:1rem 0;background-color:rgb(84, 84, 84);color:#fff;max-width:100%;margin-top:auto;}.hide{display:none;margin-left:33%;width:33%;text-align:center;}.show{position:absolute;color:white;font-size:2rem;padding:2rem;height:max-content;opacity:0.9;border-radius:0.5rem;transition:linear 0.5s 3s;display:block;z-index:10;}label{padding-left:2rem;margin:1rem;height:fit-content;color:black;}th{color:black;font-size:1.5rem;width:17%;margin-bottom:2rem;}tr{display:flex;}td{display:flex;flex-direction:column;width:17%;}input[type='file']{font-size:1rem;border:none;border-radius:5px;background-color:#0662a8;color:#0662a8;width:8rem;margin:0;border:0;padding:5px;}#titles{width:fit-content;display:flex;justify-content:center;gap:2rem;align-items:center;outline:none;}.title_head{display:flex;align-items:center;justify-content:space-around;opacity:0.5;}#exit{margin-right:2rem;}h2, h3{text-align:center;margin-top:1rem;}input[type='submit']{margin-right:100%;}.controlBut[type='button']{font-size:larger;font-weight:800;background-color:#8cadc6;color:white;margin-left:40%;display:block;}.danger{background-color:#b51b1b;}.danger[type='button']{background-color:#b51b1b;}table{width:100%;}";

const char* SCRIPT_STR = "const DPF='d';function setActionsData(schema,values){if(schema?.length==14&&values?.length%5==0){let vi=0;let si=0;for(let d=0;d<7;d++){let td=document.getElementById(DPF+d);if(td&&td.children){while(td.children.length>2){removeAction(td);}let n =+schema[si++]*10 + +schema[si++];for(let c=0;c<n && vi<values.length;++c){const str_val = ''+values[vi++]+values[vi++]+':'+values[vi++]+values[vi++];addAction(d,td,str_val, values[vi++]=='1'?true:false);}}}}}function get_schema_data(sch){return sch.map(el=>Math.trunc(el/10)+''+ el%10).join('');}const LIST_DAY=['Monday','Thusday','Wednesday','Thursday','Friday','Saturday','Sanday'];const START_VAR_CHECKBOX=2;const FORMS_LIST=[[['Network',['SSID','PWD']],['text','64']],[['Update',['Firmware']],['file',]],[['Status',['WiFi STA Ok','Time Ok','Rele state','Timer activate']],['checkbox',]],];const modal=window.document.getElementById('modal');function addAction(day,td,str_val,checked){let rmBut=null;if(td.children.length==1){rmBut=document.createElement('input');rmBut.type='button';rmBut.value='-';rmBut.onclick=()=>{removeAction(td)};rmBut.classList='controlBut danger';td.insertBefore(rmBut,td.children[0]);}else{rmBut=td.children[td.children.length-2];}const position=td.children.length-2;let inpTime=document.createElement('input');inpTime.type='time';inpTime.name=day+'t'+position;inpTime.required=true;if(str_val)inpTime.value=str_val;inpCh=document.createElement('input');inpCh.type='checkbox';inpCh.name=day+'c'+position;if(checked)inpCh.checked=true;td.insertBefore(inpTime,rmBut);td.insertBefore(inpCh,rmBut);}function removeAction(td){td.removeChild(td.children[td.children.length-3]);td.removeChild(td.children[td.children.length-3]);if(td.children.length==2)td.removeChild(td.children[td.children.length-2]);}function createActions(){const form=document.createElement('form');form.name='Actions';form.action='';const fieldset=document.createElement('fieldset');const legend=document.createElement('legend');legend.innerText='Actions';fieldset.appendChild(form);fieldset.appendChild(legend);const tr_head=document.createElement('tr');const table=document.createElement('table');LIST_DAY.forEach((e)=>{const th=document.createElement('th');th.innerText=e;tr_head.appendChild(th);});const tr_body=document.createElement('tbody');const row=document.createElement('tr');for(let day=0;day<LIST_DAY.length;++day){const td=document.createElement('td');const input=document.createElement('input');input.type='button';input.value='+';td.id=DPF+day;input.onclick=()=>{addAction(day,td)};input.classList.add('controlBut');td.appendChild(input);row.appendChild(td);}tr_body.appendChild(row);table.appendChild(tr_head);table.appendChild(tr_body);const submit=document.createElement('input');submit.value='Submit';submit.type='submit';form.appendChild(table);form.appendChild(submit);document.getElementById('settings_forms').appendChild(fieldset);}function getSetting(){fetch('/data?',{method:'POST',mode:'no-cors',body:null,}).then((r)=>r.json()).then((r)=>{for(const key in r){const value=r[key];if(key==='schema'){setActionsData(r['schema'], r['values']);}else if(key==='Status'){const flags=Number(value);[...document.querySelectorAll('[type=checkbox]')].forEach((checkbox,i)=>{checkbox.checked=flags&(1<<i);});}else{const input=document.getElementById(key);if(input)input.value=value;}}}).catch((e)=>showModal(e));}function createForms(){const containerForms=document.getElementById('settings_forms');FORMS_LIST.forEach((data)=>{const [name,listInput]=data[0];const [type,length]=data[1];const form=document.createElement('form');const container=document.createElement('div');const fieldset=document.createElement('fieldset');const legend=document.createElement('legend');legend.innerText=name;fieldset.appendChild(form);fieldset.appendChild(legend);form.name=name;form.action='';const submit=document.createElement('input');submit.value='Submit';submit.type='submit';listInput.forEach((inputName,i)=>{const label=document.createElement('label');label.innerText=inputName+'';const input=document.createElement('input');input.type=type;input.id=inputName;input.name=inputName;if(type==='text'){input.value='';input.maxLength=length;input.placeholder='Enter'+inputName;}else if(type=='checkbox'&&i<START_VAR_CHECKBOX){input.disabled=true;}label.appendChild(input);form.appendChild(label);});form.appendChild(submit);container.appendChild(fieldset);containerForms.appendChild(container);});}function getInfo(){sdf('info');}function serverExit(){sdf('close');document.getElementById('exit').classList.add('danger');}function showModal(str,success){modal.innerText=str?str:':(';modal.style['background-color']=success===true?'green':'red';modal.classList.add('show');const leftPos=(window.innerWidth-modal.offsetWidth)/2;const topPos=(window.innerHeight-modal.offsetHeight)/2+window.scrollY;modal.style.right=leftPos+'px';modal.style.top=topPos+'px';setTimeout(()=>{modal.classList.remove('show');},5000);}document.body.addEventListener('submit',(e)=>{e.preventDefault();e.stopPropagation();sendData(e.target.name);});function sendData(fn){const js={};const arr=[];const sch=[0,0,0,0,0,0,0];let data=null;let flags=0;let i=0;const childsList=document.forms[fn];if(childsList){for(const child of childsList){let value=child.value;if(value){if(child.type==='text'){if(!data)data=js;js[child.name]=value;}else if(child.type==='file'){data=child.files[0];break;}else if(child.type==='time'){const day=Number(child.name.split('t')[0]);++sch[day];const arr_time=value.split(':');arr.push(arr_time[0],arr_time[1]);}else if(child.type==='checkbox'){if(fn=='Actions'){arr.push(child.checked?'1':'0')}else{if(child.checked){flags|=1<<i;}i++;}}}}if(fn=='Actions'){data=JSON.stringify({schema:get_schema_data(sch),values:arr.join('')});}else if(data===js){data=JSON.stringify(js);}else{data=flags;}sdf(fn,data);}}async function sdf(path,data){let res=true;await fetch('/'+path,{method:'POST',mode:'no-cors',body:data,}).then((r)=>{if(!r.ok)res=false;return r.text()}).then((r)=>showModal(r,res)).catch((e)=>showModal(e,false));}createForms();createActions();";